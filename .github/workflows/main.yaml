name: Model Training Pipeline

on: [push] # Cháº¡y má»—i khi cÃ³ code má»›i Ä‘Æ°á»£c push

jobs:
  run-training:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write
      issues: write
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      # 1. CÃ i Ä‘áº·t Python & CML
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Setup Kaggle Config
        run: |
          pip install kaggle jq
          mkdir -p ~/.kaggle
          echo '{"username":"${{ secrets.KAGGLE_USERNAME }}","key":"${{ secrets.KAGGLE_KEY }}"}' > ~/.kaggle/kaggle.json
          chmod 600 ~/.kaggle/kaggle.json

      # 2. PUSH CODE VÃ€ Tá»° QUáº¢N LÃ VIá»†C CHá»œ Äá»¢I (POLLING)
      - name: Push Kernel and Poll for Status
        id: kaggle_process
        env:
          KERNEL_SLUG: ${{ secrets.KAGGLE_USERNAME }}/detection-system
          DAGSHUB_TOKEN_SECRET: ${{ secrets.DAGSHUB_TOKEN }} # Láº¥y token vÃ o biáº¿n mÃ´i trÆ°á»ng táº¡m
        run: |
          echo "ğŸ’‰ Äang tiÃªm Token vÃ o code..."
          # DÃ¹ng sed Ä‘á»ƒ thay tháº¿ Placeholder báº±ng Token tháº­t
          # LÆ°u Ã½: DÃ¹ng dáº¥u | lÃ m phÃ¢n cÃ¡ch Ä‘á»ƒ trÃ¡nh lá»—i náº¿u Token cÃ³ chá»©a kÃ½ tá»± /
          sed -i "s|DAGSHUB_TOKEN_PLACEHOLDER|${DAGSHUB_TOKEN_SECRET}|g" kaggle_runner.py

          echo "ğŸš€ Äáº©y code lÃªn Kaggle..."
          kaggle kernels push -p .

          # QUAN TRá»ŒNG: Revert (hoÃ n tÃ¡c) láº¡i file ngay Ä‘á»ƒ trÃ¡nh lá»™ token náº¿u lá»¡ cÃ³ ai cat file ra log
          # (Tuy nhiÃªn runner sáº½ bá»‹ há»§y sau khi cháº¡y xong nÃªn bÆ°á»›c nÃ y lÃ  cáº©n tháº­n thÃªm thÃ´i)
          git checkout kaggle_runner.py 

          echo "â³ Äang Ä‘á»£i Kaggle training..."
          status="running"
          
          while [[ "$status" != "complete" && "$status" != "error" ]]; do
            sleep 60
            full_status=$(kaggle kernels status $KERNEL_SLUG)
            status=$(echo $full_status | grep -oP '(?<=status: )\w+')
            echo "Current Status: $status"
            if [[ -z "$status" ]]; then status="running"; fi
          done

          if [[ "$status" == "error" ]]; then
            echo "âŒ Training bá»‹ lá»—i!"
            kaggle kernels output $KERNEL_SLUG -p ./logs
            cat ./logs/*.log
            exit 1
          else
            echo "âœ… Training hoÃ n táº¥t!"
          fi
        
      