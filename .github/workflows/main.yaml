name: Model Training Pipeline

on: [push] # Cháº¡y má»—i khi cÃ³ code má»›i Ä‘Æ°á»£c push

jobs:
  run-training:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write
      issues: write
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      # 1. CÃ i Ä‘áº·t Python & CML
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Setup Kaggle Config
        run: |
          pip install kaggle jq
          mkdir -p ~/.kaggle
          echo '{"username":"${{ secrets.KAGGLE_USERNAME }}","key":"${{ secrets.KAGGLE_KEY }}"}' > ~/.kaggle/kaggle.json
          chmod 600 ~/.kaggle/kaggle.json

      # 2. PUSH CODE VÃ€ Tá»° QUáº¢N LÃ VIá»†C CHá»œ Äá»¢I (POLLING)
      - name: Push Kernel and Poll for Status
        id: kaggle_process
        env:
          KERNEL_SLUG: ${{ secrets.KAGGLE_USERNAME }}/detection-system-training
          # Äáº·t tÃªn biáº¿n mÃ´i trÆ°á»ng khá»›p vá»›i lá»‡nh sed bÃªn dÆ°á»›i
          DAGSHUB_TOKEN: ${{ secrets.DAGSHUB_TOKEN }} 
        run: |
          echo "ğŸ’‰ Äang tiÃªm Token vÃ o code (BÆ°á»›c nÃ y Ä‘ang thiáº¿u nÃ¨)..."
          # 1. TIÃŠM TOKEN (QUAN TRá»ŒNG NHáº¤T - KHÃ”NG ÄÆ¯á»¢C Bá» QUA)
          # TÃ¬m chá»¯ PLACEHOLDER thay báº±ng Token tháº­t
          sed -i "s|DAGSHUB_TOKEN_PLACEHOLDER|${DAGSHUB_TOKEN}|g" kaggle_runner.py

          # Kiá»ƒm tra nháº¹ xem file Ä‘Ã£ Ä‘á»•i chÆ°a (che bá»›t token Ä‘á»ƒ báº£o máº­t log)
          echo "Kiá»ƒm tra file sau khi inject (chá»‰ in 5 dÃ²ng Ä‘áº§u):"
          head -n 5 kaggle_runner.py

          echo "ğŸš€ Äáº©y code lÃªn Kaggle..."
          kaggle kernels push -p .

          # 2. NGá»¦ Äá»‚ TRÃNH Lá»–I NHáº¬N DIá»†N SAI TRáº NG THÃI
          echo "ğŸ’¤ Ngá»§ 60s Ä‘á»ƒ Kaggle ká»‹p reset tráº¡ng thÃ¡i..."
          sleep 60 

          # 3. Dá»ŒN Dáº¸P FILE (HoÃ n tÃ¡c viá»‡c sá»­a token Ä‘á»ƒ git sáº¡ch sáº½)
          git checkout kaggle_runner.py 

          echo "â³ Báº¯t Ä‘áº§u theo dÃµi tráº¡ng thÃ¡i..."
          
          # Táº¯t cháº¿ Ä‘á»™ "há»… lá»—i lÃ  dá»«ng" Ä‘á»ƒ vÃ²ng láº·p cháº¡y bá»n bá»‰
          set +e 
          status="running"
          
          while [[ "$status" != "complete" && "$status" != "error" ]]; do
            sleep 60
            
            full_status=$(kaggle kernels status $KERNEL_SLUG)
            echo "ğŸ” Raw output: $full_status"
            
            # LOGIC Xá»¬ LÃ TRáº NG THÃI THÃ”NG MINH
            if [[ "$full_status" == *"COMPLETE"* ]] || [[ "$full_status" == *"complete"* ]]; then
              status="complete"
            elif [[ "$full_status" == *"ERROR"* ]] || [[ "$full_status" == *"error"* ]]; then
              status="error"
            else
              status="running"
            fi
            
            echo "Current Status Parsed: $status"
          done

          # Báº­t láº¡i cháº¿ Ä‘á»™ báº¯t lá»—i
          set -e

          if [[ "$status" == "error" ]]; then
            echo "âŒ Training bá»‹ lá»—i! Äang táº£i log vá»..."
            kaggle kernels output $KERNEL_SLUG -p ./logs
            cat ./logs/*.log
            exit 1
          else
            echo "âœ… Training hoÃ n táº¥t!"
          fi