name: Model Training Pipeline

on: [push] # Cháº¡y má»—i khi cÃ³ code má»›i Ä‘Æ°á»£c push

jobs:
  run-training:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write
      issues: write
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      # 1. CÃ i Ä‘áº·t Python & CML
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Setup Kaggle Config
        run: |
          pip install kaggle jq
          mkdir -p ~/.kaggle
          echo '{"username":"${{ secrets.KAGGLE_USERNAME }}","key":"${{ secrets.KAGGLE_KEY }}"}' > ~/.kaggle/kaggle.json
          chmod 600 ~/.kaggle/kaggle.json

      # 2. PUSH CODE VÃ€ Tá»° QUáº¢N LÃ VIá»†C CHá»œ Äá»¢I (POLLING)
      - name: Push Kernel and Poll for Status
        id: kaggle_process
        env:
          # Thay báº±ng user/slug cá»§a báº¡n (VÃ­ dá»¥: rom1009/detection-system)
          KERNEL_SLUG: ${{ secrets.KAGGLE_USERNAME }}/detection-system
        run: |
          echo "ğŸš€ Äáº©y code lÃªn Kaggle..."
          kaggle kernels push -p . # Assumes kernel-metadata.json is in root

          echo "â³ Äang Ä‘á»£i Kaggle training..."
          status="running"
          
          # VÃ²ng láº·p kiá»ƒm tra tráº¡ng thÃ¡i (Timeout sau 2 tiáº¿ng náº¿u cáº§n thÃªm logic Ä‘áº¿m)
          while [[ "$status" != "complete" && "$status" != "error" ]]; do
            sleep 60 # Äá»£i 1 phÃºt rá»“i há»i láº¡i
            
            # Láº¥y tráº¡ng thÃ¡i hiá»‡n táº¡i (dÃ¹ng jq Ä‘á»ƒ parse hoáº·c grep)
            # Lá»‡nh status tráº£ vá» dáº¡ng: "ref, status, lastRunTime..."
            full_status=$(kaggle kernels status $KERNEL_SLUG)
            status=$(echo $full_status | grep -oP '(?<=status: )\w+')
            
            echo "Current Status: $status"
            
            # Náº¿u status bá»‹ rá»—ng (do lá»—i máº¡ng), gÃ¡n láº¡i running Ä‘á»ƒ khÃ´ng crash script
            if [[ -z "$status" ]]; then status="running"; fi
          done

          if [[ "$status" == "error" ]]; then
            echo "âŒ Training bá»‹ lá»—i trÃªn Kaggle!"
            kaggle kernels output $KERNEL_SLUG -p ./logs
            cat ./logs/*.log # In log ra Ä‘á»ƒ debug
            exit 1
          else
            echo "âœ… Training hoÃ n táº¥t thÃ nh cÃ´ng!"
          fi
        
      