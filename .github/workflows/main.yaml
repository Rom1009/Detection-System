name: Model Training Pipeline

on: [push] # Cháº¡y má»—i khi cÃ³ code má»›i Ä‘Æ°á»£c push

jobs:
  run-training:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write
      issues: write
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      # 1. CÃ i Ä‘áº·t Python & CML
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Setup Kaggle Config
        run: |
          pip install kaggle jq
          mkdir -p ~/.kaggle
          echo '{"username":"${{ secrets.KAGGLE_USERNAME }}","key":"${{ secrets.KAGGLE_KEY }}"}' > ~/.kaggle/kaggle.json
          chmod 600 ~/.kaggle/kaggle.json

      # 2. PUSH CODE VÃ€ Tá»° QUáº¢N LÃ VIá»†C CHá»œ Äá»¢I (POLLING)
      - name: Push Kernel and Poll
        id: kaggle_process
        env:
          KERNEL_SLUG: ${{ secrets.KAGGLE_USERNAME }}/detection-system
          MY_TOKEN: ${{ secrets.DAGSHUB_TOKEN }} # Láº¥y token ra biáº¿n mÃ´i trÆ°á»ng
        run: |
          # 1. Táº O FILE Má»’I (Launcher)
          # File nÃ y sáº½ Ä‘Æ°á»£c Kaggle cháº¡y Ä‘áº§u tiÃªn. NÃ³ chá»©a Token vÃ  gá»i file chÃ­nh cá»§a báº¡n.
          echo "import os" > start.py
          echo "print('ğŸš€ Starting launcher...')" >> start.py
          # Gá»i file runner cÅ© vÃ  truyá»n token vÃ o nhÆ° cÃ¡ch báº¡n muá»‘n
          echo "os.system('python kaggle_runner.py $MY_TOKEN')" >> start.py

          # 2. Cáº¬P NHáº¬T METADATA
          # Sá»­a file json Ä‘á»ƒ trá» vÃ o start.py thay vÃ¬ kaggle_runner.py
          # (DÃ¹ng jq Ä‘á»ƒ sá»­a code_file táº¡m thá»i)
          jq '.code_file = "start.py"' kernel-metadata.json > kernel-metadata.json.tmp && mv kernel-metadata.json.tmp kernel-metadata.json

          # 3. Äáº¨Y CODE LÃŠN KAGGLE
          echo "ğŸš€ Äáº©y code lÃªn Kaggle..."
          kaggle kernels push -p .

          # 4. HOÃ€N TÃC (Dá»n dáº¹p)
          # XÃ³a file má»“i vÃ  tráº£ láº¡i file json gá»‘c Ä‘á»ƒ khÃ´ng lÃ m báº©n git
          rm start.py
          git checkout kernel-metadata.json

          # 5. POLLING (VÃ²ng láº·p chá» nhÆ° cÅ©)
          echo "â³ Äang Ä‘á»£i Kaggle training..."
          status="running"
          while [[ "$status" != "complete" && "$status" != "error" ]]; do
            sleep 60
            full_status=$(kaggle kernels status $KERNEL_SLUG)
            status=$(echo $full_status | grep -oP '(?<=status: )\w+')
            echo "Current Status: $status"
            if [[ -z "$status" ]]; then status="running"; fi
          done

          if [[ "$status" == "error" ]]; then
            echo "âŒ Training bá»‹ lá»—i!"
            kaggle kernels output $KERNEL_SLUG -p ./logs
            cat ./logs/*.log
            exit 1
          else
            echo "âœ… Training hoÃ n táº¥t!"
          fi
        
      