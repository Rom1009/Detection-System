name: Model Training Pipeline

on: [push] # Chạy mỗi khi có code mới được push

jobs:
  run-training:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write
      issues: write
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      # 1. Cài đặt Python & CML
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      # 3. TẠO FILE CREDENTIAL TỪ SECRET (Bước quan trọng nhất)
      # GitHub Runner sẽ lấy nội dung từ Secret và tạo lại file json
      - name: Run DVC Pipeline on Kaggle with DAGsHub
        uses: KevKibe/kaggle-script-action@v1.0.5
        env:
          DAGSHUB_TOKEN: ${{ secrets.DAGSHUB_TOKEN }}
        with:
          username: ${{ secrets.KAGGLE_USERNAME }}
          key: ${{ secrets.KAGGLE_KEY }}
          title: "Run Training Pipeline"
          enable_gpu: true
          enable_internet: true
          # ĐÃ XÓA DÒNG 'language: python' VÌ ACTION KHÔNG HỖ TRỢ
          custom_script: |
            # Dừng ngay lập tức nếu có bất kỳ lệnh nào bị lỗi (Tương tự check_call)
            set -e
            
            echo "=== STARTING PIPELINE ON KAGGLE (BASH MODE) ==="

            # 1. Clone Code
            # Kiểm tra folder chưa tồn tại thì clone
            if [ ! -d "Detection-System" ]; then
                echo "Step 1: Cloning Repository..."
                git clone --branch dev https://github.com/Rom1009/Detection-System.git
            fi

            # Di chuyển vào thư mục
            cd Detection-System
            echo "Current Directory: $(pwd)"

            # 2. Cài đặt thư viện
            echo "Step 2: Installing Dependencies..."
            pip install dvc mlflow dagshub
            pip install -r backend/requirements.txt

            # 3. Setup Auth (Dùng biến môi trường $DAGSHUB_TOKEN)
            echo "Step 3: Configuring Auth..."
            dvc remote modify origin --local auth basic
            dvc remote modify origin --local user token
            dvc remote modify origin --local password "$DAGSHUB_TOKEN"

            # 4. Pull Data
            echo "Step 4: Pulling Data..."
            dvc pull

            # 5. Setup MLflow Environment Variables
            echo "Step 5: Training & Tracking..."
            export MLFLOW_TRACKING_URI="https://dagshub.com/japanesegirl2002/Detection-System.mlflow"
            export MLFLOW_TRACKING_USERNAME="japanesegirl2002"
            export MLFLOW_TRACKING_PASSWORD="$DAGSHUB_TOKEN"

            # 6. Run Training
            # Lệnh này sẽ chạy quy trình định nghĩa trong dvc.yaml
            dvc repro

            echo "=== PIPELINE FINISHED SUCCESSFULLY ==="
        
      