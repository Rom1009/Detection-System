name: Model Training Pipeline

on: [push] # Ch·∫°y m·ªói khi c√≥ code m·ªõi ƒë∆∞·ª£c push

jobs:
  run-training:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write
      issues: write
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      # 1. C√†i ƒë·∫∑t Python & CML
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      # 2. C√†i ƒë·∫∑t th∆∞ vi·ªán
      - name: Install dependencies
        run: |
          pip install -r backend/requirements.txt
          pip install dvc[gdrive] # Nh·ªõ c√†i g√≥i h·ªó tr·ª£ gdrive

      # 3. T·∫†O FILE CREDENTIAL T·ª™ SECRET (B∆∞·ªõc quan tr·ªçng nh·∫•t)
      # GitHub Runner s·∫Ω l·∫•y n·ªôi dung t·ª´ Secret v√† t·∫°o l·∫°i file json
      - name: Run DVC Pipeline on Kaggle with DAGsHub
        uses: KevKibe/kaggle-script-action@v1.0.5
        env:
          DAGSHUB_TOKEN: ${{ secrets.DAGSHUB_TOKEN }}
        with:
          username: ${{ secrets.KAGGLE_USERNAME }}
          key: ${{ secrets.KAGGLE_KEY }}
          title: "Run Training Pipeline"
          enable_gpu: true
          enable_internet: true
          language: python
          custom_script: |
            import os
            import subprocess

            # 1. Setup Token (L·∫•y t·ª´ bi·∫øn m√¥i tr∆∞·ªùng c·ªßa Action)
            # L∆∞u √Ω: Kh√¥ng hardcode token v√†o script
            DAGSHUB_TOKEN = os.getenv("DAGSHUB_TOKEN")
            
            # H√†m ch·∫°y l·ªánh an to√†n (Thay th·∫ø cho c√°ch c≈© b·ªã l·ªói)
            # check_call s·∫Ω t·ª± ƒë·ªông d·ª´ng ch∆∞∆°ng tr√¨nh n·∫øu l·ªánh b·ªã l·ªói
            def run(cmd):
                print("üöÄ Executing: " + cmd)
                subprocess.check_call(cmd, shell=True)

            print("=== STARTING PIPELINE ON KAGGLE ===")

            # 2. Clone Code
            if not os.path.exists("Detection-System"):
                 run("git clone --branch dev https://github.com/Rom1009/Detection-System.git")
            
            os.chdir("Detection-System")
            print("üìÇ Current Working Directory: " + os.getcwd())
            
            # 3. C√†i ƒë·∫∑t th∆∞ vi·ªán
            print("üì¶ Installing Dependencies...")
            run("pip install dvc mlflow dagshub")
            run("pip install -r backend/requirements.txt")

            # 4. Setup Auth DAGsHub
            print("üîê Configuring Auth...")
            run("dvc remote modify origin --local auth basic")
            run("dvc remote modify origin --local user token")
            # D√πng concatenation (+) thay v√¨ f-string ƒë·ªÉ tr√°nh l·ªói YAML parse
            run("dvc remote modify origin --local password " + DAGSHUB_TOKEN)

            # 5. Pull Data
            print("‚¨áÔ∏è Pulling Data from DAGsHub...")
            run("dvc pull")

            # 6. Training & Tracking
            print("üî• Starting Training...")
            os.environ["MLFLOW_TRACKING_URI"] = "https://dagshub.com/japanesegirl2002/Detection-System.mlflow"
            os.environ["MLFLOW_TRACKING_USERNAME"] = "japanesegirl2002"
            os.environ["MLFLOW_TRACKING_PASSWORD"] = DAGSHUB_TOKEN
            
            run("dvc repro")
            
            print("‚úÖ PIPELINE FINISHED SUCCESSFULLY!")
        
      