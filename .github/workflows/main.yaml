name: Model Training Pipeline

on: [push] # Ch·∫°y m·ªói khi c√≥ code m·ªõi ƒë∆∞·ª£c push

jobs:
  run-training:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write
      issues: write
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      # 1. C√†i ƒë·∫∑t Python & CML
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Setup Kaggle Config
        run: |
          pip install kaggle jq
          mkdir -p ~/.kaggle
          echo '{"username":"${{ secrets.KAGGLE_USERNAME }}","key":"${{ secrets.KAGGLE_KEY }}"}' > ~/.kaggle/kaggle.json
          chmod 600 ~/.kaggle/kaggle.json

      # 2. PUSH CODE V√Ä T·ª∞ QU·∫¢N L√ù VI·ªÜC CH·ªú ƒê·ª¢I (POLLING)
      - name: Push Kernel and Poll for Status
        id: kaggle_process
        env:
          KERNEL_SLUG: ${{ secrets.KAGGLE_USERNAME }}/detection-system-training
          DAGSHUB_TOKEN: ${{ secrets.DAGSHUB_TOKEN }} # L·∫•y token v√†o bi·∫øn m√¥i tr∆∞·ªùng t·∫°m
        run: |
          # ... (Ph·∫ßn tr√™n gi·ªØ nguy√™n) ...
          echo "‚è≥ ƒêang ƒë·ª£i Kaggle training..."
          
          # 1. T·∫ÆT CH·∫æ ƒê·ªò "H·ªÑ L·ªñI L√Ä CH·∫æT" (QUAN TR·ªåNG NH·∫§T)
          echo "üöÄ ƒê·∫©y code l√™n Kaggle..."
          kaggle kernels push -p .

          # --- FIX QUAN TR·ªåNG ·ªû ƒê√ÇY ---
          echo "üí§ Ng·ªß 60s ƒë·ªÉ Kaggle k·ªãp reset tr·∫°ng th√°i..."
          sleep 60 
          # ----------------------------

          # Revert l·∫°i file code (d·ªçn d·∫πp)
          git checkout kaggle_runner.py 

          echo "‚è≥ B·∫Øt ƒë·∫ßu theo d√µi tr·∫°ng th√°i..."
          
          # T·∫Øt exit on error
          set +e 
          status="running"
          
          while [[ "$status" != "complete" && "$status" != "error" ]]; do
            sleep 60
            
            full_status=$(kaggle kernels status $KERNEL_SLUG)
            echo "üîç Raw: $full_status"
            
            # --- LOGIC X·ª¨ L√ù M·ªöI (ROBUST) ---
            
            # 1. Ki·ªÉm tra xem c√≥ ch·ªØ "COMPLETE" ho·∫∑c "complete" trong chu·ªói kh√¥ng
            # (C√°ch n√†y an to√†n h∆°n d√πng regex tr√≠ch xu·∫•t)
            if [[ "$full_status" == *"COMPLETE"* ]] || [[ "$full_status" == *"complete"* ]]; then
              status="complete"
            
            # 2. Ki·ªÉm tra l·ªói
            elif [[ "$full_status" == *"ERROR"* ]] || [[ "$full_status" == *"error"* ]]; then
              status="error"
              
            # 3. N·∫øu kh√¥ng ph·∫£i 2 c√°i tr√™n th√¨ coi nh∆∞ ƒëang running
            else
              status="running"
            fi
            
            echo "Current Status Parsed: $status"
          done

          # 4. B·∫¨T L·∫†I CH·∫æ ƒê·ªò B·∫ÆT L·ªñI
          set -e

          if [[ "$status" == "error" ]]; then
            echo "‚ùå Training b·ªã l·ªói!"
            kaggle kernels output $KERNEL_SLUG -p ./logs
            cat ./logs/*.log
            exit 1
          else
            echo "‚úÖ Training ho√†n t·∫•t!"
          fi
        