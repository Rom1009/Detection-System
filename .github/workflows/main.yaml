name: Model Training Pipeline

on: [push] # Ch·∫°y m·ªói khi c√≥ code m·ªõi ƒë∆∞·ª£c push

jobs:
  run-training:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write
      issues: write
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      # 1. C√†i ƒë·∫∑t Python & CML
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Setup Kaggle Config
        run: |
          pip install kaggle jq
          mkdir -p ~/.kaggle
          echo '{"username":"${{ secrets.KAGGLE_USERNAME }}","key":"${{ secrets.KAGGLE_KEY }}"}' > ~/.kaggle/kaggle.json
          chmod 600 ~/.kaggle/kaggle.json

      # 2. PUSH CODE V√Ä T·ª∞ QU·∫¢N L√ù VI·ªÜC CH·ªú ƒê·ª¢I (POLLING)
      - name: Push Kernel and Poll for Status
        id: kaggle_process
        env:
          KERNEL_SLUG: ${{ secrets.KAGGLE_USERNAME }}/detection-system-training
          DAGSHUB_TOKEN: ${{ secrets.DAGSHUB_TOKEN }} # L·∫•y token v√†o bi·∫øn m√¥i tr∆∞·ªùng t·∫°m
        run: |
          # ... (Ph·∫ßn tr√™n gi·ªØ nguy√™n) ...
          echo "‚è≥ ƒêang ƒë·ª£i Kaggle training..."
          
          # 1. T·∫ÆT CH·∫æ ƒê·ªò "H·ªÑ L·ªñI L√Ä CH·∫æT" (QUAN TR·ªåNG NH·∫§T)
          set +e 
          
          status="running"
          
          while [[ "$status" != "complete" && "$status" != "error" ]]; do
            sleep 60
            
            # 2. L·∫•y to√†n b·ªô output ra ƒë·ªÉ debug xem Kaggle tr·∫£ v·ªÅ c√°i g√¨
            full_status=$(kaggle kernels status $KERNEL_SLUG)
            echo "üîç Raw output from Kaggle: $full_status"
            
            # 3. L·ªçc status an to√†n h∆°n
            # D√πng "|| echo running" ƒë·ªÉ n·∫øu grep l·ªói th√¨ n√≥ v·∫´n tr·∫£ v·ªÅ ch·ªØ "running" ch·ª© kh√¥ng crash script
            # S·ª≠a regex m·ªôt ch√∫t: Kaggle th∆∞·ªùng tr·∫£ v·ªÅ: has status "running" (c√≥ d·∫•u ngo·∫∑c k√©p)
            status=$(echo "$full_status" | grep -oP '(?<=status ")\w+' || echo "running")
            
            # Fix tr∆∞·ªùng h·ª£p regex c≈© kh√¥ng b·∫Øt ƒë∆∞·ª£c d·∫•u ngo·∫∑c k√©p
            if [[ "$status" == "running" && "$full_status" == *"complete"* ]]; then
              status="complete"
            fi
            
            echo "Current Status: $status"
          done

          # 4. B·∫¨T L·∫†I CH·∫æ ƒê·ªò B·∫ÆT L·ªñI
          set -e

          if [[ "$status" == "error" ]]; then
            echo "‚ùå Training b·ªã l·ªói!"
            kaggle kernels output $KERNEL_SLUG -p ./logs
            cat ./logs/*.log
            exit 1
          else
            echo "‚úÖ Training ho√†n t·∫•t!"
          fi
        