name: Model Training Pipeline

on: [push] # Chạy mỗi khi có code mới được push

jobs:
  run-training:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write
      issues: write
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      # 1. Cài đặt Python & CML
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      # 3. TẠO FILE CREDENTIAL TỪ SECRET (Bước quan trọng nhất)
      # GitHub Runner sẽ lấy nội dung từ Secret và tạo lại file json
      - name: Run DVC Pipeline on Kaggle with DAGsHub
        uses: KevKibe/kaggle-script-action@v1.0.5
        env:
          DAGSHUB_TOKEN: ${{ secrets.DAGSHUB_TOKEN }}
        with:
          username: ${{ secrets.KAGGLE_USERNAME }}
          key: ${{ secrets.KAGGLE_KEY }}
          title: "Run Training Pipeline"
          enable_gpu: true
          enable_internet: true
          language: python
          custom_script: |
            #!/usr/bin/env python3
            import os
            import subprocess
            import sys

            # Lấy token
            DAGSHUB_TOKEN = os.getenv("DAGSHUB_TOKEN")

            print("--- STARTING PIPELINE ON KAGGLE ---")

            # 1. Clone Code
            # Kiểm tra nếu chưa có code thì mới clone
            if not os.path.exists("Detection-System"):
                print("Step 1: Cloning Repository...")
                subprocess.check_call("git clone --branch dev https://github.com/Rom1009/Detection-System.git", shell=True)
            
            # Di chuyển vào thư mục
            if os.path.exists("Detection-System"):
                os.chdir("Detection-System")
                print("Moved to Detection-System folder")

            # 2. Cài đặt thư viện
            print("Step 2: Installing Dependencies...")
            subprocess.check_call("pip install dvc mlflow dagshub", shell=True)
            subprocess.check_call("pip install -r backend/requirements.txt", shell=True)

            # 3. Setup Auth
            print("Step 3: Configuring Auth...")
            subprocess.check_call("dvc remote modify origin --local auth basic", shell=True)
            subprocess.check_call("dvc remote modify origin --local user token", shell=True)
            # Dùng concatenation (+) an toàn hơn f-string trong YAML
            subprocess.check_call("dvc remote modify origin --local password " + DAGSHUB_TOKEN, shell=True)

            # 4. Pull Data
            print("Step 4: Pulling Data...")
            subprocess.check_call("dvc pull", shell=True)

            # 5. Training
            print("Step 5: Training & Tracking...")
            # Setup biến môi trường cho MLflow
            os.environ["MLFLOW_TRACKING_URI"] = "https://dagshub.com/japanesegirl2002/Detection-System.mlflow"
            os.environ["MLFLOW_TRACKING_USERNAME"] = "japanesegirl2002"
            os.environ["MLFLOW_TRACKING_PASSWORD"] = DAGSHUB_TOKEN
            
            # Chạy lệnh train
            subprocess.check_call("dvc repro", shell=True)
            
            print("--- PIPELINE FINISHED ---")
        
      